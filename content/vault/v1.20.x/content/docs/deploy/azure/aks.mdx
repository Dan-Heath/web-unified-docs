---
layout: docs
page_title: Deploy Vault on Microsoft AKS
description: >-
  Guide to deploying and setting up Vault on Microsoft Azure Kubernetes Service (AKS).
---

# Deploy Vault on Azure Kubernetes Service (AKS)

Azure Kubernetes Service (AKS) can run Vault in a managed Kubernetes cluster with the Vault UI enabled for web-based secrets management.

In this guide, you create a cluster in AKS, install Vault with the Web UI enabled, and then configure the authentication between Vault and the cluster. Then you deploy a web application with deployment annotations so the Vault Agent injector service installs application's.

## Prerequisites

- [Azure account](https://azure.microsoft.com/en-us/account/) 
- [Azure command-line interface (cli)](https://docs.microsoft.com/en-us/cli/azure/)
- [Kubernetes CLI](https://kubernetes.io/docs/tasks/tools/install-kubectl/)
- [Helm CLI](https://helm.sh/docs/helm/)

In addition you need to have the Vault Helm chart. You can add the Helm repositories with the following commands:

```shell-session
$ helm repo add hashicorp https://helm.releases.hashicorp.com
"hashicorp" has been added to your repositories
```

This guide focuses on setting up HashiCorp Vault on Azure AKS and assumes a understanding of both Azure Kubernetes concepts and terminology.  The guide assumes the user is familiar with Azure groups, AKS, Kubernetes pods, service accounts, and manifests.  

## Step 1: Start cluster

1. Log in to your Azure account with the Azure CLI.

1. Create a resource group named `learn-vault` with the location specified.

   ```shell-session
   $ az group create --name learn-vault --location eastus
   ```

1. Create a cluster named `learn-vault-cluster` with `1` node in the `learn-vault` resource group.

   ```shell-session
   $ az aks create --resource-group learn-vault \
      --name learn-vault-cluster \
      --node-count 1 \
      --enable-addons monitoring \
      --generate-ssh-keys
   ```

1. When the cluster is ready, configure the `kubectl` CLI to communicate to the `learn-vault-cluster` cluster.

   ```shell-session
   $ az aks get-credentials --resource-group learn-vault --name learn-vault-cluster
   ```

1. Helm deploys the Vault pod and Vault Agent Injector pod in the default namespace.

   ```shell-session
   $ helm install vault hashicorp/vault --set 'server.dev.enabled=true'
   ```

The `vault-agent-injector` pod deployed is a Kubernetes Mutation Webhook Controller. The controller intercepts pod events and applies mutations to the pod if specific annotations exist within the request.

## Step 2: Set a secret in Vault

1. Set a secret at the path `secret/data/devwebapp/config` with the `username` and `password` keys.

   ```shell-session
   $ kubectl exec vault-0 -- vault kv put -mount=secret devwebapp/config username=giraffe password=salsa
   ```

## Step 3: Configure Kubernetes authentication

Vault provides a [Kubernetes authentication](/vault/docs/auth/kubernetes) method that enables clients to authenticate with a Kubernetes Service Account Token.

   ```shell-session
   $ kubectl exec vault-0 -- vault auth enable kubernetes
   ```

1. You need the Kubernetes host URL, service account JWT token, and CA certificate to configure the Kubernetes authentication method.

   ```shell-session
   $ KUBE_PORT="https://$( kubectl exec vault-0 -- env | grep KUBERNETES_PORT_443_TCP_ADDR| cut -f2 -d'='):443"
   ```

   ```shell-session
   $ SA_JWT="$(kubectl exec vault-0 -- cat /var/run/secrets/kubernetes.io/serviceaccount/token)"
   ```

   ```shell-session
   $ CA_CRT=$(kubectl exec vault-0 -- cat /var/run/secrets/kubernetes.io/serviceaccount/ca.crt)
   ```
1. Configure the Kubernetes authentication method with the Kubernetes host URL, service account JWT token, and CA certificate.

   ```shell-session
   $ kubectl exec vault-0 -- vault write auth/kubernetes/config \
      token_reviewer_jwt=$SA_JWT \
      kubernetes_host=$KUBE_PORT \
      kubernetes_ca_cert=$CA_CRT
   ```
   
## Step 4: Configure web application authentication

For a client of the Vault server to read the secret data defined earlier, it requires that the read capability for the path `secret/data/devwebapp/config`.

   ```shell-session
   $ kubectl exec -i vault-0 -- vault policy write devwebapp - <<'EOF'
   path "secret/data/devwebapp/config" {
      capabilities = ["read"]
   }
   EOF
   ```
   
   ```shell-session
   $ kubectl exec -i vault-0 -- vault write auth/kubernetes/role/devweb-app \
      audience=https://learn-vaul-learn-vault-1-XXXXXX-2f0NNNNNN.hcp.eastus.azmk8s.io \
      bound_service_account_names=internal-app \
      bound_service_account_namespaces=default \
      policies=devwebapp \
      ttl=1h
   ```

   <Note title='Audience field and the service account JWT'>

<<<<<<< Updated upstream
    When creating a named role, Vault 1.21+ recommends the audience field to match the aud field of the JWT service account token. This is a security measure to ensure that the token intended for use with Service Account is correct.
=======
   When creating a named role, Vault 1.21+ recommends the audience field to match the aud field of the JWT service account token. This is a security measure to ensure that the token intended for use with Service Account is correct.
>>>>>>> Stashed changes

   </Note>

## Step 5: Deploy web application

1. Create a manifest for service account named `internal-app`.

   ```shell-session
   $ cat > internal-app.yaml <<EOF
   apiVersion: v1
   kind: ServiceAccount
   metadata:
   name: internal-app
   EOF
   ```

1. Create the `internal-app` service account.

   ```shell-session
   $ kubectl apply --filename internal-app.yaml
   ```

1. Define a pod named `devwebapp` with the web application.

   ```shell-session
   $ cat > devwebapp.yaml <<EOF
   ---
   apiVersion: v1
   kind: Pod
   metadata:
   name: devwebapp
   labels:
      app: devwebapp
   annotations:
      vault.hashicorp.com/agent-inject: "true"
      vault.hashicorp.com/role: "devweb-app"
      vault.hashicorp.com/agent-inject-secret-credentials.txt: "secret/data/devwebapp/config"
   spec:
   serviceAccountName: internal-app
   containers:
      - name: devwebapp
         image: caddy
   EOF
   ```

   This definition creates a pod with the specified container running with the `internal-app` Kubernetes service account. The container within the pod is    unaware of the Vault cluster. The Vault Injector service reads the [annotations](/vault/docs/platform/k8s/injector#annotations)
   to find the secret path, stored within Vault at `secret/data/devwebapp/config` and the file location, `/vault/secrets/secret-credentials.txt`, to mount that secret with the pod.

1. Create the `devwebapp` pod.

   ```shell-session
   $ kubectl apply --filename devwebapp.yaml
   ```

   Wait until the `devwebapp` pod reports that is running and ready.

1. Display the secrets written to the file `/vault/secrets/secret-credentials.txt`
on the `devwebapp` pod.

   ```shell-session
   $ kubectl exec --stdin=true --tty=true devwebapp --container=devwebapp \
      -- cat /vault/secrets/credentials.txt
   ```

## Step 6: Clean up

Destroy the cluster.

```shell-session
$ az group delete --name learn-vault --yes --no-wait
```