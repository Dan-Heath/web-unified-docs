---
layout: docs
page_title: Deploy Vault on Microsoft AKS
description: >-
  Guide to deploying and setting up Vault on Microsoft Azure Kubernetes Service (AKS).
---

Azure Kubernetes Service (AKS) can run Vault in a managed Kubernetes cluster
with the Vault UI enabled for web-based secrets management.

In this guide, you create a cluster in AKS, install Vault with the Web UI
enabled, and then configure the authentication between Vault and the cluster.
Then you deploy a web application with deployment annotations so the
application's secrets are installed via the Vault Agent injector service.

## Prerequisites

- [Azure account](https://azure.microsoft.com/en-us/account/) 
- [azure command-line interface (cli)](https://docs.microsoft.com/en-us/cli/azure/)
- [Kubernetes CLI](https://kubernetes.io/docs/tasks/tools/install-kubectl/)
- [Helm CLI](https://helm.sh/docs/helm/)

In addition you need to have the Vault Helm chart. You can add the
Helm repositories with the following commands:

```shell-session
$ helm repo add hashicorp https://helm.releases.hashicorp.com
"hashicorp" has been added to your repositories
```

## Step 1: Start cluster

Kubernetes clusters may run one or more nodes. Each node contains the services
to run pods. Vault running in standalone mode requires one node.

1. Create a resource group named `learn-vault` with the location specified.

```shell-session
$ az group create --name learn-vault --location eastus
```

1. Create a cluster named `learn-vault-cluster` with `1` node in the `learn-vault`
resource group.

```shell-session
$ az aks create --resource-group learn-vault \
    --name learn-vault-cluster \
    --node-count 1 \
    --enable-addons monitoring \
    --generate-ssh-keys
```

1. When the cluster is ready, the `kubectl` CLI requires configuration to
communicate with this cluster.

Configure the `kubectl` CLI to communicate to the `learn-vault-cluster` cluster.

```shell-session
$ az aks get-credentials --resource-group learn-vault --name learn-vault-cluster
Merged "learn-vault-cluster" as current context in /Users/USERNAME/.kube/config
```

1. Install the latest version of the Vault Helm chart with the Web UI enabled.

```shell-session
$ helm install vault hashicorp/vault \
   --set 'server.dev.enabled=true'
```

The Vault pod, Vault Agent Injector pod, and Vault UI Kubernetes service are
deployed in the default namespace.

The `vault-agent-injector` pod deployed is a Kubernetes Mutation Webhook
Controller. The controller intercepts pod events and applies mutations to the
pod if specific annotations exist within the request.

## Step 2: Set a secret in Vault

1. Set a secret at the path `secret/data/devwebapp/config` with the
`username` and `password` keys.

```shell-session
$ kubectl exec vault-0 -- vault kv put -mount=secret devwebapp/config username=giraffe password=salsa
```

## Step 3: Configure Kubernetes authentication

Vault provides a [Kubernetes
authentication](/vault/docs/auth/kubernetes) method
that enables clients to authenticate with a Kubernetes Service Account
Token.

```shell-session
$ kubectl exec vault-0 -- vault auth enable kubernetes
```

1. You need the Kubernetes host URL, service account JWT token, and CA certificate to configure the Kubernetes authentication method.


   ```shell-session
   $ KUBE_PORT="https://$( kubectl exec vault-0 -- env | grep KUBERNETES_PORT_443_TCP_ADDR| cut -f2 -d'='):443"
   ```

   ```shell-session
   $ SA_JWT="$(kubectl exec vault-0 -- cat /var/run/secrets/kubernetes.io/serviceaccount/token)"
   ```

   ```shell-session
   $ CA_CRT=$(kubectl exec vault-0 -- cat /var/run/secrets/kubernetes.io/serviceaccount/ca.crt)
   ```
1. Configure the Kubernetes authentication method with the values retrieved in the previous step.

   ```shell-session
   $ kubectl exec vault-0 -- vault write auth/kubernetes/config \
    kubernetes_host=$KUBE_PORT
   ```

   ```shell-session
   $ kubectl exec vault-0 -- vault write auth/kubernetes/config \
      token_reviewer_jwt=$SA_JWT \
      kubernetes_host=$KUBE_PORT \
      kubernetes_ca_cert=$CA_CRT
   ```
   
The Kubernetes authentication method is configured to work within the cluster.
The web application requires a Vault policy to read the secret and a
Kubernetes role to grant it that policy.

## Step 4: Configure web application authentication

For a client of the Vault server to read the secret data defined in the [Set a
secret in Vault](#set-a-secret-in-vault) step requires that the read
capability be granted for the path `secret/data/devwebapp/config`.

   ```shell-session
   $ kubectl exec -i vault-0 -- vault policy write devwebapp - <<'EOF'
   path "secret/data/devwebapp/config" {
      capabilities = ["read"]
   }
   EOF
   ```
   
```shell-session
$ kubectl exec -i vault-0 -- vault write auth/kubernetes/role/devweb-app \
    audience=https://learn-vaul-learn-vault-1-XXXXXX-2f0NNNNNN.hcp.eastus.azmk8s.io
    bound_service_account_names=internal-app \
    bound_service_account_namespaces=default \
    policies=devwebapp \
    ttl=1h
   ```

   <Note title='Audience field and the service account JWT'>

    When creating a named role, Vault 1.21+ recommends the audience field to match the aud field of the JWT service account token. This is a security measure to ensure that the token intended for use with Service Account is correct.

   </Note>

   The role is created and the view displays its name in the roles view for this authentication method.

## Step 5: Deploy web application

```shell-session
$ cat > internal-app.yaml <<EOF
apiVersion: v1
kind: ServiceAccount
metadata:
  name: internal-app
EOF
```

Create the `internal-app` service account.

```shell-session
$ kubectl apply --filename internal-app.yaml
```

Define a pod named `devwebapp` with the web application.

```shell-session
$ cat > devwebapp.yaml <<EOF
---
apiVersion: v1
kind: Pod
metadata:
  name: devwebapp
  labels:
    app: devwebapp
  annotations:
    vault.hashicorp.com/agent-inject: "true"
    vault.hashicorp.com/role: "devweb-app"
    vault.hashicorp.com/agent-inject-secret-credentials.txt: "secret/data/devwebapp/config"
spec:
  serviceAccountName: internal-app
  containers:
    - name: devwebapp
      image: caddy
EOF
```

This definition creates a pod with the specified container running with the
`internal-app` Kubernetes service account. The container within the pod is
unaware of the Vault cluster. The Vault Injector service reads the
[annotations](/vault/docs/platform/k8s/injector#annotations)
to find the secret path, stored within Vault at `secret/data/devwebapp/config`
and the file location, `/vault/secrets/secret-credentials.txt`, to mount
that secret with the pod.

Create the `devwebapp` pod.

```shell-session
$ kubectl apply --filename devwebapp.yaml
```

Wait until the `devwebapp` pod reports that is running and ready.

Display the secrets written to the file `/vault/secrets/secret-credentials.txt`
on the `devwebapp` pod.

```shell-session
$ kubectl exec --stdin=true --tty=true devwebapp --container=devwebapp \
    -- cat /vault/secrets/credentials.txt
```

## Step 6: Clean up

Destroy the cluster.

```shell-session
$ az group delete --name learn-vault --yes --no-wait
```
